pipeline {
    agent any

      environment {
    NETLIFY_SITE_ID = 'df7bc3b7-664f-4ac6-8028-252e6bb64850'
    NETLIFY_AUTH_TOKEN = credentials('netilfy-token')
}
    stages {
        stages {
        stage('Checkout') {
            steps {
                sh'''
                echo 'Checking out code from repository...'
                checkout scm
                '''
            }
        }
        stage('Build') {
            agent {
                docker {
                    image 'nginx:latest'
                    reuseNode true
                }
            }
        
            steps {
                echo 'Building static site...'

                // Installer Nginx
                sh '''
                apk add --no-cache nginx

                # Créer un dossier build et y copier les fichiers statiques
                mkdir -p dist
                cp -r src/* build/
                ls -la
                echo "Static site built successfully."

                # Copier les fichiers statiques dans le répertoire Nginx
                cp -r build/* /usr/share/nginx/html/

                # Vérifier que Nginx fonctionne en lançant le service
                nginx -g 'daemon off;' &
                ls -la
                '''
            }
        }

        
    
       stage('test'){
         agent {
                docker{
                    image 'node:18-alpine'
                    reuseNode true
                }
            }
        steps {
            
            sh '''
             #test -f dist/test.html
             npm test
               '''
        }
       }




     stage('Deploy') {
            agent {
                docker {
                    image 'nginx:latest'
                    reuseNode true
                }
            }
            steps {
                sh  '''
                    npm install netlify-cli
                    node_modules/.bin/netlify --version 
                    echo 'deploy production . SITE ID:${NETLIFY_SITE_ID}'
                    node_modules/.bin/netlify status
                    node_modules/.bin/netlify deploy --dir=build --prod

                  '''
            }
        }

       }
   
}}
