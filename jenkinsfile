pipeline {
    agent any

      environment {
    NETLIFY_SITE_ID = 'df7bc3b7-664f-4ac6-8028-252e6bb64850'
    NETLIFY_AUTH_TOKEN = credentials('netilfy-token')
    BUILD_DIR = 'build'
}
    stages {
    
        stage('Checkout') {
            steps {
                
                echo 'Checking out code from repository...'
                checkout scm
                
            }
        }
        stage('Build') {
            agent {
                docker {
                    image 'nginx:latest'
                    reuseNode true
                }
            }
        
            steps {
                echo 'Building static site...'

                // Installer Nginx
                sh '''
                apt-get update
                apt-get install -y nginx
                # Créer un dossier build et y copier les fichiers statiques
                mkdir -p dist
                cp -r src/* build/
                ls -la
                echo "Static site built successfully."

                # Copier les fichiers statiques dans le répertoire Nginx
                cp -r build/* /usr/share/nginx/html/

                # Vérifier que Nginx fonctionne en lançant le service
                nginx -g 'daemon off;' &
                ls -la
                '''
            }
        }

        
    

     stage('Deploy') {
    agent {
        docker {
            image 'nginx:latest'  // Utilisation de l'image officielle Nginx
            reuseNode true
        }
    }
   
    steps {
        script {
            // Installer le CLI de Netlify
            sh 'npm install -g netlify-cli'
            
            // Vérifier la version de Netlify CLI
            sh 'netlify --version'
            
            // Déployer sur Netlify
            sh '''
                echo "Déploiement sur Netlify..."
                netlify deploy --dir=${BUILD_DIR} --prod --site=${NETLIFY_SITE_ID} --auth ${NETLIFY_AUTH_TOKEN}
            '''
            
            // Si vous souhaitez utiliser Nginx pour servir l'application localement (optionnel)
            echo "Copie des fichiers dans Nginx pour un test local"

            // Copier les fichiers de l'application dans le répertoire Nginx
            sh '''
                cp -r ${BUILD_DIR}/* /usr/share/nginx/html/
                nginx -t  # Vérifier la configuration de Nginx
                nginx -g 'daemon off;'  # Démarrer Nginx en mode non-démon
            '''
        }
    }
}


       }
   
}
